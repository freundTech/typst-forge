name: Build all packages

on:
  push:
    branches:
      - main
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    - uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.31.0
        activate-environment: true

    - name: Run code in changed subdirectories
      shell: bash
      env:
        TARGET_PLATFORM: ${{ matrix.target }}

      run: |
        rattler-build build --recipe-dir . --variant-config global-variants.yaml \
          --skip-existing=all --no-test \
          -c conda-forge/label/typst_rc -c conda-forge -c https://prefix.dev/typst-forge

    - name: Upload Unix Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: unix-packages
        path: output/**/*_unix.conda

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: win-packages
        path: output/**/*_win.conda

  test:
    needs: [build]
    strategy:
      matrix:
        include:
          - { target: "win", os: "windows-latest" }
          - { target: "unix", os: "ubuntu-latest" }
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.31.0
          activate-environment: true
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.target }}-packages
      - name: Run tests
        shell: bash
        run: |
          for file in output/**/*.conda; do
            if ! rattler-build test -c conda-forge/label/typst_rc -c conda-forge -c typst-forge --package-file "$file"; then
              rm "$file"
            fi
          done
      - name: Upload all packages
        shell: bash
        # do not upload on PR
        if: github.event_name == 'push'
        env:
          PREFIX_API_KEY: ${{ secrets.PREFIX_API_KEY }}
        run: |
          # ignore errors because we want to ignore duplicate packages
          for file in output/**/*.conda; do
            rattler-build upload prefix -c typst-forge "$file" || true
          done